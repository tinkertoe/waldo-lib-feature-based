import { Program } from './Program'
import { WaldoTexture } from '../types'
import fs from 'fs'
import path from 'path'

const fingerprintPairs: Number[] = [
  0.21,0.569,0.878,0.212,0.42,0.839,0.534,0.695,0.966,0.147,0.917,0.907,0.475,0.461,0.494,0.375,0.502,0.28,0.117,0.348,0.366,0.01,0.74,0.86,0.93,0.1,0.679,0.887,0.498,0.07,0.67,0.899,0.378,0.618,0.774,0.569,0.016,0.587,0.801,0.156,0.36,0.593,0.224,0.122,0.626,0.132,0.921,0.28,0.388,0.496,0.844,0.405,0.757,0.7,0.395,0.742,0.29,0.844,0.169,0.218,0.634,0.778,0.923,0.536,0.685,0.972,0.223,0.011,0.125,0.733,0.798,0.094,0.644,0.428,0.675,0.623,0.605,0.763,0.848,0.368,0.494,0.477,0.355,0.997,0.657,0.72,0.795,0.499,0.502,0.326,0.343,0.62,0.763,0.131,0.9,0.958,0.706,0.373,0.575,0.152,0.091,0.697,0.719,0.445,0.19,0.097,0.273,0.537,0.659,0.115,0.521,0.977,0.273,0.498,0.732,0.806,0.488,0.569,0.922,0.14,0.839,0.518,0.506,0.124,0.551,0.495,0.37,0.371,0.292,0.616,0.934,0.662,0.923,0.325,0.595,0.953,0.019,0.212,0.989,0.294,0.792,0.513,0.779,0.628,0.44,0.157,0.04,0.542,0.601,0.346,0.904,0.701,0.629,0.543,0.92,0.975,0.445,0.771,0.512,0.99,0.107,0.483,0.955,0.496,0.304,0.546,0.128,0.045,0.919,0.969,0.891,0.633,0.738,0.168,0.48,0.74,0.207,0.513,0.369,0.381,0.272,0.55,0.704,0.664,0.728,0.193,0.523,0.045,0.283,0.803,0.114,0.673,0.387,0.618,0.321,0.955,0.132,0.499,0.698,0.447,0.269,0.611,0.742,0.63,0.948,0.803,0.331,0.728,0.792,0.171,0.112,0.037,0.815,0.873,0.735,0.165,0.746,0.899,0.508,0.843,0.993,0.39,0.457,0.743,0.215,0.176,0.409,0.125,0.858,0.759,0.429,0.678,0.431,0.928,0.824,0.85,0.884,0.823,0.186,0.37,0.186,0.405,0.732,0.372,0.923,0.088,0.982,0.563,0.067,0.873,0.691,0.425,0.202,0.355,0.627,0.314
]
const fragShaderSource = fs.readFileSync(path.join(__dirname, './shaders/computeFeatures.fs'), 'utf8').replace(/FINGERPRINT_PAIRS/gm , fingerprintPairs.length.toString())

export class ComputeFeatures extends Program {
  constructor(gl: WebGLRenderingContext) {
    super(gl, fragShaderSource)
  }

  public run(image: WaldoTexture): WaldoTexture {
    this.outputDimensions(image.dimensions, 'float')
    this.render({
      u_image: image.texture,
      u_imageDimensions: [ image.dimensions.w, image.dimensions.h ],
      u_patchSize: 8,
      u_fingerprintPairs: fingerprintPairs
    })
    return this.outputTexture
  }
}